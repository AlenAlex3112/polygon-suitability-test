) %>%
# Layer: Regional Rarities (The "Value-Capped" Outliers)
addPolygons(
data = map_corr,
fillColor = ~pal_rarities(outlier_count),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Rarities",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "orange", bringToFront = TRUE)
) %>%
# Layer: Regional Similarity (Spearman Rank Correlation)
addPolygons(
data = map_corr,
fillColor = ~pal_corr(regional_corr),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Similarity",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "cyan", bringToFront = TRUE)
) %>%
# Layer: Species Density (Unique species count)
addPolygons(
data = map_density_h3,
fillColor = ~pal_density(unique_species),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Species Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# Layer: Checklist Density (Effort/Count of GROUP.ID)
addPolygons(
data = map_effort_h3,
fillColor = ~pal_effort(checklist_count),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Checklist Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# 3. Add Legends
addLegend(pal = pal_corr, values = c(-1, 1),
title = "Similarity Index", position = "bottomright") %>%
addLegend(pal = pal_rarities, values = map_corr$outlier_count,
title = "Rare Bird Count", position = "topright") %>%
addLegend(pal = pal_density, values = map_density_h3$unique_species,
title = "Species Count", position = "bottomleft") %>%
addLegend(pal = pal_effort, values = map_effort_h3$checklist_count,
title = "Checklists", position = "topleft") %>%
# 4. Layer Controls
addLayersControl(
overlayGroups = c("Regional Rarities", "Regional Similarity", "Species Density",
"Checklist Density", "No Data Zones", "Boundaries"),
options = layersControlOptions(collapsed = FALSE)
) %>%
# Hide these layers by default to keep the initial view focused
hideGroup(c("Regional Similarity", "Species Density", "Checklist Density", "No Data Zones"))
# 5. Save Final Widget
saveWidget(m, file = "Kerala_Bird_Final_Analysis.html", selfcontained = TRUE)
grid_counts <- data_req %>%
group_by(h3_id) %>%
reframe(unique_species = n_distinct(COMMON.NAME))
# 2. Checklist counts per cell (Effort)
grid_effort <- data_req %>%
group_by(h3_id) %>%
reframe(checklist_count = n_distinct(GROUP.ID))
# 3. Rank statistics per species per cell (Local)
grid_stats <- data_req %>%
group_by(h3_id) %>%
mutate(total_lists = n_distinct(GROUP.ID)) %>%
ungroup() %>%
group_by(h3_id, total_lists, COMMON.NAME, polygon_id) %>%
summarise(detections = n_distinct(GROUP.ID), .groups = "drop") %>%
mutate(frequency = detections / total_lists) %>%
group_by(h3_id) %>%
arrange(desc(frequency)) %>%
filter(frequency >= 0.1) %>%
mutate(rank = row_number()) %>%
ungroup() %>%
as.data.frame()
# 4. Rank statistics per species per polygon (Regional)
polygon_stats <- data_req %>%
group_by(polygon_id) %>%
mutate(total_lists = n_distinct(GROUP.ID)) %>%
ungroup() %>%
group_by(polygon_id, total_lists, COMMON.NAME) %>%
summarise(detections = n_distinct(GROUP.ID), .groups = "drop") %>%
mutate(frequency = detections / total_lists) %>%
group_by(polygon_id) %>%
arrange(desc(frequency)) %>%
filter(frequency >= 0.05) %>%
mutate(rank = row_number()) %>%
ungroup() %>%
as.data.frame()
# SECTION 4: SPECIES SIMILARITY MATH --------------------------------------
calc <- function(target_h3, target_poly, grid_df, poly_df) {
local_sp <- grid_df[grid_df$h3_id == target_h3, c("COMMON.NAME", "frequency")]
poly_master <- poly_df %>%
filter(polygon_id == target_poly) %>%
select(COMMON.NAME, poly_freq = frequency)
merged <- inner_join(local_sp, poly_master, by = "COMMON.NAME")
if (nrow(merged) < 5) return(NA)
merged <- merged %>%
mutate(
local_rank_new = min_rank(desc(frequency)),
poly_rank_new  = min_rank(desc(poly_freq))
)
return(cor(merged$local_rank_new, merged$poly_rank_new, method = "spearman"))
}
comparison_tasks <- grid_stats %>%
distinct(h3_id, polygon_id)
results <- comparison_tasks %>%
mutate(regional_corr = map2_dbl(
.x = h3_id,
.y = polygon_id,
.f = ~calc(.x, .y, grid_stats, polygon_stats)
)) %>%
filter(!is.na(regional_corr))
calc_outliers <- function(target_h3, target_poly, grid_df, poly_df, threshold = 0.1) {
# Get local species that meet the absolute frequency threshold
local_species <- grid_df %>%
filter(h3_id == target_h3, frequency >= threshold) %>%
pull(COMMON.NAME)
# Typical regional species already filtered in polygon_stats (now by absolute value)
poly_typical  <- poly_df %>%
filter(polygon_id == target_poly) %>%
pull(COMMON.NAME)
# Species that are significant locally but missing from regional top list
outliers <- setdiff(local_species, poly_typical)
return(tibble(
outlier_count = length(outliers),
outlier_list = if(length(outliers) > 0) paste(sort(outliers), collapse = ", ") else "None"
))
}
# Re-run outlier results with the new logic
outlier_results <- comparison_tasks %>%
group_by(h3_id, polygon_id) %>%
reframe(calc_outliers(h3_id, polygon_id, grid_stats, polygon_stats, threshold = 0.1))
results <- results %>%
left_join(outlier_results, by = c("h3_id", "polygon_id"))
# SECTION 5: SPATIAL CONVERSION FOR PLOTTING ------------------------------
# 1. Create a lookup table for Polygon Names
polygon_lookup <- map %>%
st_drop_geometry() %>%
select(polygon_id = id, subregion) %>%
distinct()
word_safe_wrap <- function(x, width = 50) {
if (is.na(x) || x == "None" || x == "") return("None")
# strwrap breaks at spaces and returns a character vector of lines
wrapped_lines <- strwrap(x, width = width)
# Collapse the lines using the HTML break tag
return(paste(wrapped_lines, collapse = "<br>"))
}
# 2. Build the unified_stats using joins (now including outlier data from 'results')
# 1. Prepare the unified stats
unified_stats <- grid_counts %>%
left_join(grid_effort, by = "h3_id") %>%
left_join(results %>% select(h3_id, regional_corr, polygon_id, outlier_count, outlier_list), by = "h3_id") %>%
left_join(polygon_lookup, by = "polygon_id") %>%
mutate(
subregion_name = ifelse(is.na(subregion), "Unknown", subregion),
# Apply the word-safe wrap (50 chars wide)
wrapped_rarities = sapply(outlier_list, word_safe_wrap, width = 50),
hover_label = glue(
"<b>{subregion_name}</b><br/>",
"<hr style='margin:3px 0;'>",
"<b>Species:</b> {unique_species}<br/>",
"<b>Checklists:</b> {checklist_count}<br/>",
"<b>Similarity Index:</b> {ifelse(is.na(regional_corr), 'N/A', round(regional_corr, 2))}<br/>",
"<p style='color: #d9534f; margin: 5px 0 0 0;'><b>Regional Rarities ({outlier_count}):</b></p>",
"<i style='font-size: 0.85em; color: #555;'>{wrapped_rarities}</i>"
) %>% map(htmltools::HTML)
)
# 3. Re-create spatial objects with the unified labels
map_corr <- cell_to_polygon(results$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
map_density_h3 <- cell_to_polygon(grid_counts$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
map_effort_h3 <- cell_to_polygon(grid_effort$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
empty_h3_ids <- setdiff(h3_ids, grid_counts$h3_id)
empty_grids_h3 <- cell_to_polygon(empty_h3_ids, simple = FALSE)
# ==============================================================================
# SECTION 6: GENERATE LEAFLET MAP ----------------------------------------------
# ==============================================================================
# 1. Define Palettes
# Similarity Index: Red (Unique) to Blue (Typical)
pal_corr <- colorNumeric(palette = "RdYlBu", domain = c(-1, 1), na.color = "transparent")
# Species Density: Yellow to Red
pal_density <- colorNumeric(palette = "YlOrRd", domain = map_density_h3$unique_species)
# Checklist Effort: Custom Bins in Purple
effort_bins <- c(0, 10, 25, 50, 100, 500, 1000, Inf)
pal_effort <- colorBin(palette = "Purples", domain = map_effort_h3$checklist_count, bins = effort_bins)
# Regional Rarities: Orange/Brown based on count of birds >5% local freq but rare regionally
pal_rarities <- colorBin(palette = "YlOrBr", domain = map_corr$outlier_count, bins = c(0, 1, 3, 5, 10, 20, Inf))
# 2. Build the Map
m <- leaflet() %>%
addProviderTiles(providers$CartoDB.Positron) %>%
# --- CUSTOM PANE FOR BOUNDARIES ---
# This ensures boundaries stay above the data layers at all times
addMapPane("boundary_pane", zIndex = 450) %>%
# Layer: Kerala Subregion Boundaries
addPolygons(
data = map,
fill = FALSE,
color = "black",
weight = 3,
group = "Boundaries",
options = pathOptions(pane = "boundary_pane") # Assigned to top pane
) %>%
# Layer: No Data Zones (Cells in Kerala with 0 checklists)
addPolygons(
data = empty_grids_h3,
fillColor = "#333333",
fillOpacity = 0.4,
weight = 0.5,
color = "#444444",
group = "No Data Zones"
) %>%
# Layer: Regional Rarities (The "Value-Capped" Outliers)
addPolygons(
data = map_corr,
fillColor = ~pal_rarities(outlier_count),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Rarities",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "orange", bringToFront = TRUE)
) %>%
# Layer: Regional Similarity (Spearman Rank Correlation)
addPolygons(
data = map_corr,
fillColor = ~pal_corr(regional_corr),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Similarity",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "cyan", bringToFront = TRUE)
) %>%
# Layer: Species Density (Unique species count)
addPolygons(
data = map_density_h3,
fillColor = ~pal_density(unique_species),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Species Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# Layer: Checklist Density (Effort/Count of GROUP.ID)
addPolygons(
data = map_effort_h3,
fillColor = ~pal_effort(checklist_count),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Checklist Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# 3. Add Legends
addLegend(pal = pal_corr, values = c(-1, 1),
title = "Similarity Index", position = "bottomright") %>%
addLegend(pal = pal_rarities, values = map_corr$outlier_count,
title = "Rare Bird Count", position = "topright") %>%
addLegend(pal = pal_density, values = map_density_h3$unique_species,
title = "Species Count", position = "bottomleft") %>%
addLegend(pal = pal_effort, values = map_effort_h3$checklist_count,
title = "Checklists", position = "topleft") %>%
# 4. Layer Controls
addLayersControl(
overlayGroups = c("Regional Rarities", "Regional Similarity", "Species Density",
"Checklist Density", "No Data Zones", "Boundaries"),
options = layersControlOptions(collapsed = FALSE)
) %>%
# Hide these layers by default to keep the initial view focused
hideGroup(c("Regional Similarity", "Species Density", "Checklist Density", "No Data Zones"))
# 5. Save Final Widget
saveWidget(m, file = "Kerala_Bird_Final_Analysis.html", selfcontained = TRUE)
# 3. Rank statistics per species per cell (Local)
grid_stats <- data_req %>%
group_by(h3_id) %>%
mutate(total_lists = n_distinct(GROUP.ID)) %>%
ungroup() %>%
group_by(h3_id, total_lists, COMMON.NAME, polygon_id) %>%
summarise(detections = n_distinct(GROUP.ID), .groups = "drop") %>%
mutate(frequency = detections / total_lists) %>%
group_by(h3_id) %>%
arrange(desc(frequency)) %>%
filter(frequency >= 0.1) %>%
mutate(rank = row_number()) %>%
ungroup() %>%
as.data.frame()
# 4. Rank statistics per species per polygon (Regional)
polygon_stats <- data_req %>%
group_by(polygon_id) %>%
mutate(total_lists = n_distinct(GROUP.ID)) %>%
ungroup() %>%
group_by(polygon_id, total_lists, COMMON.NAME) %>%
summarise(detections = n_distinct(GROUP.ID), .groups = "drop") %>%
mutate(frequency = detections / total_lists) %>%
group_by(polygon_id) %>%
arrange(desc(frequency)) %>%
filter(frequency >= 0.01) %>%
mutate(rank = row_number()) %>%
ungroup() %>%
as.data.frame()
calc <- function(target_h3, target_poly, grid_df, poly_df) {
local_sp <- grid_df[grid_df$h3_id == target_h3, c("COMMON.NAME", "frequency")]
poly_master <- poly_df %>%
filter(polygon_id == target_poly) %>%
select(COMMON.NAME, poly_freq = frequency)
merged <- inner_join(local_sp, poly_master, by = "COMMON.NAME")
if (nrow(merged) < 5) return(NA)
merged <- merged %>%
mutate(
local_rank_new = min_rank(desc(frequency)),
poly_rank_new  = min_rank(desc(poly_freq))
)
return(cor(merged$local_rank_new, merged$poly_rank_new, method = "spearman"))
}
comparison_tasks <- grid_stats %>%
distinct(h3_id, polygon_id)
results <- comparison_tasks %>%
mutate(regional_corr = map2_dbl(
.x = h3_id,
.y = polygon_id,
.f = ~calc(.x, .y, grid_stats, polygon_stats)
)) %>%
filter(!is.na(regional_corr))
calc_outliers <- function(target_h3, target_poly, grid_df, poly_df, threshold = 0.1) {
# Get local species that meet the absolute frequency threshold
local_species <- grid_df %>%
filter(h3_id == target_h3, frequency >= threshold) %>%
pull(COMMON.NAME)
# Typical regional species already filtered in polygon_stats (now by absolute value)
poly_typical  <- poly_df %>%
filter(polygon_id == target_poly) %>%
pull(COMMON.NAME)
# Species that are significant locally but missing from regional top list
outliers <- setdiff(local_species, poly_typical)
return(tibble(
outlier_count = length(outliers),
outlier_list = if(length(outliers) > 0) paste(sort(outliers), collapse = ", ") else "None"
))
}
# Re-run outlier results with the new logic
outlier_results <- comparison_tasks %>%
group_by(h3_id, polygon_id) %>%
reframe(calc_outliers(h3_id, polygon_id, grid_stats, polygon_stats, threshold = 0.1))
results <- results %>%
left_join(outlier_results, by = c("h3_id", "polygon_id"))
# SECTION 5: SPATIAL CONVERSION FOR PLOTTING ------------------------------
# 1. Create a lookup table for Polygon Names
polygon_lookup <- map %>%
st_drop_geometry() %>%
select(polygon_id = id, subregion) %>%
distinct()
word_safe_wrap <- function(x, width = 50) {
if (is.na(x) || x == "None" || x == "") return("None")
# strwrap breaks at spaces and returns a character vector of lines
wrapped_lines <- strwrap(x, width = width)
# Collapse the lines using the HTML break tag
return(paste(wrapped_lines, collapse = "<br>"))
}
# 2. Build the unified_stats using joins (now including outlier data from 'results')
# 1. Prepare the unified stats
unified_stats <- grid_counts %>%
left_join(grid_effort, by = "h3_id") %>%
left_join(results %>% select(h3_id, regional_corr, polygon_id, outlier_count, outlier_list), by = "h3_id") %>%
left_join(polygon_lookup, by = "polygon_id") %>%
mutate(
subregion_name = ifelse(is.na(subregion), "Unknown", subregion),
# Apply the word-safe wrap (50 chars wide)
wrapped_rarities = sapply(outlier_list, word_safe_wrap, width = 50),
hover_label = glue(
"<b>{subregion_name}</b><br/>",
"<hr style='margin:3px 0;'>",
"<b>Species:</b> {unique_species}<br/>",
"<b>Checklists:</b> {checklist_count}<br/>",
"<b>Similarity Index:</b> {ifelse(is.na(regional_corr), 'N/A', round(regional_corr, 2))}<br/>",
"<p style='color: #d9534f; margin: 5px 0 0 0;'><b>Regional Rarities ({outlier_count}):</b></p>",
"<i style='font-size: 0.85em; color: #555;'>{wrapped_rarities}</i>"
) %>% map(htmltools::HTML)
)
# 3. Re-create spatial objects with the unified labels
map_corr <- cell_to_polygon(results$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
map_density_h3 <- cell_to_polygon(grid_counts$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
map_effort_h3 <- cell_to_polygon(grid_effort$h3_id, simple = FALSE) %>%
rename(h3_id = h3_address) %>%
left_join(unified_stats, by = "h3_id")
empty_h3_ids <- setdiff(h3_ids, grid_counts$h3_id)
empty_grids_h3 <- cell_to_polygon(empty_h3_ids, simple = FALSE)
# 1. Define Palettes
# Similarity Index: Red (Unique) to Blue (Typical)
pal_corr <- colorNumeric(palette = "RdYlBu", domain = c(-1, 1), na.color = "transparent")
# Species Density: Yellow to Red
pal_density <- colorNumeric(palette = "YlOrRd", domain = map_density_h3$unique_species)
# Checklist Effort: Custom Bins in Purple
effort_bins <- c(0, 10, 25, 50, 100, 500, 1000, Inf)
pal_effort <- colorBin(palette = "Purples", domain = map_effort_h3$checklist_count, bins = effort_bins)
# Regional Rarities: Orange/Brown based on count of birds >5% local freq but rare regionally
pal_rarities <- colorBin(palette = "YlOrBr", domain = map_corr$outlier_count, bins = c(0, 1, 3, 5, 10, 20, Inf))
# 2. Build the Map
m <- leaflet() %>%
addProviderTiles(providers$CartoDB.Positron) %>%
# --- CUSTOM PANE FOR BOUNDARIES ---
# This ensures boundaries stay above the data layers at all times
addMapPane("boundary_pane", zIndex = 450) %>%
# Layer: Kerala Subregion Boundaries
addPolygons(
data = map,
fill = FALSE,
color = "black",
weight = 3,
group = "Boundaries",
options = pathOptions(pane = "boundary_pane") # Assigned to top pane
) %>%
# Layer: No Data Zones (Cells in Kerala with 0 checklists)
addPolygons(
data = empty_grids_h3,
fillColor = "#333333",
fillOpacity = 0.4,
weight = 0.5,
color = "#444444",
group = "No Data Zones"
) %>%
# Layer: Regional Rarities (The "Value-Capped" Outliers)
addPolygons(
data = map_corr,
fillColor = ~pal_rarities(outlier_count),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Rarities",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "orange", bringToFront = TRUE)
) %>%
# Layer: Regional Similarity (Spearman Rank Correlation)
addPolygons(
data = map_corr,
fillColor = ~pal_corr(regional_corr),
fillOpacity = 0.8,
weight = 1,
color = "white",
group = "Regional Similarity",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "cyan", bringToFront = TRUE)
) %>%
# Layer: Species Density (Unique species count)
addPolygons(
data = map_density_h3,
fillColor = ~pal_density(unique_species),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Species Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# Layer: Checklist Density (Effort/Count of GROUP.ID)
addPolygons(
data = map_effort_h3,
fillColor = ~pal_effort(checklist_count),
fillOpacity = 0.7,
weight = 1,
color = "white",
group = "Checklist Density",
label = ~hover_label,
highlightOptions = highlightOptions(weight = 3, color = "#666", bringToFront = TRUE)
) %>%
# 3. Add Legends
addLegend(pal = pal_corr, values = c(-1, 1),
title = "Similarity Index", position = "bottomright") %>%
addLegend(pal = pal_rarities, values = map_corr$outlier_count,
title = "Rare Bird Count", position = "topright") %>%
addLegend(pal = pal_density, values = map_density_h3$unique_species,
title = "Species Count", position = "bottomleft") %>%
addLegend(pal = pal_effort, values = map_effort_h3$checklist_count,
title = "Checklists", position = "topleft") %>%
# 4. Layer Controls
addLayersControl(
overlayGroups = c("Regional Rarities", "Regional Similarity", "Species Density",
"Checklist Density", "No Data Zones", "Boundaries"),
options = layersControlOptions(collapsed = FALSE)
) %>%
# Hide these layers by default to keep the initial view focused
hideGroup(c("Regional Similarity", "Species Density", "Checklist Density", "No Data Zones"))
# 5. Save Final Widget
saveWidget(m, file = "Kerala_Bird_Final_Analysis.html", selfcontained = TRUE)
??tidyverse
library(skimmr)
library(sf)
library(h3jsr)
library(dplyr)
library(purrr)
library(tidyverse)
